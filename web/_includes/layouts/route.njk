---
layout: layouts/base.njk
templateClass: tmpl-route
---

<article>
  <h1>{{ route.title }}</h1>
  {% if route.authors %}
  <p>Written by {% for author in route.authors %}{{author.name}}{% endfor %}  </p>
  {% endif %}
  {% if route.mainImage %}<img src="{% imageUrlFor route.mainImage.asset._ref, 800 %}" alt="{{ route.mainImage.alt }}">{% endif %}
  {{ route.body | markdownify | safe }}
  {{ route.elevationGain }} ({{ (route.elevationGain * 3.281).toFixed(0) }}ft)
  {{ route.elevationLoss }}
  {{ route.totalDistance }} ({{ (route.totalDistance/1.609).toFixed(1) }}mi)
  {{ route.gpx }}
  <p><a href="{{ '/' | url }}">‚Üê Home</a></p>
</article>

<section>
  <div id='map' style="height:75vh; width:100vw;"></div>
  <canvas id="chart_div" style="width: 100vw; height:250px;"></canvas>

  {% if route.geoJSON %}
  {% jsbundle 'route', true | safe %}
    <script>
      import Chart from 'chart.js/auto'
      import { getRelativePosition } from 'chart.js/helpers'
      import mapboxgl from 'mapbox-gl'
      import 'mapbox-gl/dist/mapbox-gl.css'
      import {point as turfPoint, lineString as turfLineString} from '@turf/helpers'
      import turfNearestPointOnLine from '@turf/nearest-point-on-line'

      const route = {{ route.geoJSON | dump | safe }}
      const line = turfLineString(route.features[0].geometry.coordinates)

      mapboxgl.accessToken = '{{ env.mapbox_token }}';
      const map = new mapboxgl.Map({
          container: 'map',
          style: '{{ env.mapbox_style }}',
          center: {lat: 56.5405969, lon: -4.1580719 },
          zoom: 11,
          cooperativeGestures: true,
      });
      map.scrollZoom.disable();
      // Add zoom and rotation controls to the map.
      map.addControl(new mapboxgl.NavigationControl());

      {% if route.bounds %}
        map.fitBounds({{ route.bounds | dump | safe }}, {
          padding: 20
        });
      {% endif %}

      // A single point that animates along the route.
      // Coordinates are initially set to origin.
      const point = {
        'type': 'FeatureCollection',
        'features': [
          {
            'type': 'Feature',
            'properties': {},
            'geometry': {
              'type': 'Point',
              'coordinates': ''
            }
          }
        ]
      };

      map.on('load', () => {
        map.addSource('route', {
          'type': 'geojson',
          'data': route
        })

        map.addLayer({
          'id': 'route',
          'type': 'line',
          'source': 'route',
          'layout': {
            'line-join': 'round',
            'line-cap': 'round'
          },
          'paint': {
            'line-color': '#ff00ff',
            'line-width': 5
          }
        });

        map.addSource('point', {
          'type': 'geojson',
          'data': point
        });

        map.addLayer({
          'id': 'point',
          'source': 'point',
          'type': 'circle',
          'paint': {
            'circle-radius': 6.75,
            'circle-color': '#ff0000'
          }
        });
        
      })

      // Elevation Chart
      const ctx = document.getElementById('chart_div')
      const labels = [{% for point in route.elevation %}{{ point.x }}{% if not loop.last %},{% endif %}{% endfor %}]
      const data = {
        labels: labels,
        datasets: [
          {
            label: 'Elevation',
            data: [{% for point in route.elevation %}{{ point.y }}{% if not loop.last %},{% endif %}{% endfor %}],
            fill: false,
            tension: 0.25,
            borderColor: '#ff0000',
          }
        ]
      }
      const chart = new Chart(ctx, {
        type: 'line',
        data: data,
        
        options: {
          //interaction: {
          //  mode: 'x',
          //  intersect: false,
          //  position: 'nearest',
          //},
          plugins: {
            tooltip: {
              mode: 'x',
              intersect: false,
              position: 'nearest',
              callbacks: {
                beforeLabel: (e) => {
                  // Highlight corresponding map point
                  point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[e.dataIndex]
                  map.getSource('point').setData(point)
                }
              }
            }
          },
          parsing: {
            xAxisKey: 'x',
            yAxisKey: 'y'
          },
          elements: {
            point: {
              pointRadius: 0
            }
          },
        },
      })

      const chartArea = chart.chartArea
      const tooltip = chart.tooltip
      
      // Highlight point on elevation line
      map.on('click', 'route', (e) => {
        const selected = turfPoint(e.lngLat.toArray())
        const snapped = turfNearestPointOnLine(line, selected, {units: 'miles'});

        point.features[0].geometry.coordinates = snapped.geometry.coordinates;
        map.getSource('point').setData(point);

        chart.setActiveElements([
          {datasetIndex: 0, index: snapped.properties.index},
        ])
        tooltip.setActiveElements([
          {datasetIndex: 0, index: snapped.properties.index}
        ], {x: 0, y: 0})
        chart.update()
      })

    </script>
  {% endjsbundle %}
  {% endif %}

</section>